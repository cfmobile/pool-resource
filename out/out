#!/bin/sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging



# for jq
PATH=/usr/local/bin:$PATH

payload=$(mktemp $TMPDIR/pool-resource-request.XXXXXX)

cat > $payload <&0


uri=$(jq -r '.source.uri // ""' < $payload)
branch=$(jq -r '.source.branch // ""' < $payload)
pool=$(jq -r '.source.pool // ""' < $payload)


branchflag=""
if [ -n "$branch" ]; then
  branchflag="--branch $branch"
fi

destination=$TMPDIR/git-resource-repo-cache

git clone $uri $branchflag $destination

cd $destination

lock=$(ls $pool/unclaimed/$* | gsort -R | head -n 1)

git mv $pool/unclaimed/$lock $pool/claimed/$lock

git add .
git commit -m "claming $lock"

remotebranch="master"
if [ -n "$branch" ]; then
  remotebranch=$branch
fi
git push origin $remotebranch

jq -n "{
  version: {ref: $(git rev-parse HEAD | jq -R .)},
  metadata: [{
    \"name\": \"lock_name\",
    \"value\": \"$lock\"
  },{
    \"name\": \"pool_name\",
    \"value\": \"$pool\"
  }]
}" >&3
